---
categories:
- ""
- ""
date: "2017-10-31T22:26:09-05:00"
description: Lorem Etiam Nullam
draft: false
image: pic09.jpg
keywords: ""
slug: bike
title: Bike Rentals Analysis
---

<script src="Bike Rentals Analysis_files/header-attrs/header-attrs.js"></script>


<div id="excess-rentals-in-tfl-bike-sharing" class="section level1">
<h1>Excess rentals in TfL bike sharing</h1>
<p>We use the TfL data on how many bikes were hired every single day. We can get the latest data by running the following</p>
<pre class="r"><code>url &lt;- &quot;https://data.london.gov.uk/download/number-bicycle-hires/ac29363e-e0cb-47cc-a97a-e216d900a6b0/tfl-daily-cycle-hires.xlsx&quot;

# Download TFL data to temporary file
httr::GET(url, write_disk(bike.temp &lt;- tempfile(fileext = &quot;.xlsx&quot;)))</code></pre>
<pre><code>## Response [https://airdrive-secure.s3-eu-west-1.amazonaws.com/london/dataset/number-bicycle-hires/2021-08-23T14%3A32%3A29/tfl-daily-cycle-hires.xlsx?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAJJDIMAIVZJDICKHA%2F20210915%2Feu-west-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20210915T203214Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=71135b4b1c2d17c5385e3c5e98c6d18b7fde088636527408cf35f8dc81f67743&amp;X-Amz-SignedHeaders=host]
##   Date: 2021-09-15 20:32
##   Status: 200
##   Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
##   Size: 173 kB
## &lt;ON DISK&gt;  C:\Users\LEO~1.LEO\AppData\Local\Temp\RtmpCaYyXv\file3b143ccf29bb.xlsx</code></pre>
<pre class="r"><code># Use read_excel to read it as dataframe
bike0 &lt;- read_excel(bike.temp,
                   sheet = &quot;Data&quot;,
                   range = cell_cols(&quot;A:B&quot;))

# change dates to get year, month, and week
bike &lt;- bike0 %&gt;% 
  clean_names() %&gt;% 
  rename (bikes_hired = number_of_bicycle_hires) %&gt;% 
  mutate (year = year(day),
          month = lubridate::month(day, label = TRUE),
          week = isoweek(day))</code></pre>
<p>We calculate an average benchmark for every month using the data from 2016-2019. Then we compare every month from 2016-present to that derived benchmark and color the graph depending on the actual rentals exceed the expected rental (the benchmark) or not.</p>
<pre class="r"><code># Calculate monthly bike change 
monthly_expected_rentals &lt;- bike %&gt;% 
  filter(year %in% c(2016,2017,2018,2019)) %&gt;%  
  group_by(month) %&gt;% 
  summarize(expected_rentals=mean(bikes_hired))

# Calculate actual monthly rentals mean
monthly_actual_rentals &lt;- bike %&gt;% 
  filter(year %in% c(2016,2017,2018,2019,2020,2021)) %&gt;%  
  group_by(year, month) %&gt;% 
  summarize(actual_rentals=mean(bikes_hired))

df &lt;- inner_join(monthly_expected_rentals, monthly_actual_rentals) %&gt;% 
  mutate(up = case_when((actual_rentals - expected_rentals) &gt; 0 
                        ~ actual_rentals - expected_rentals, 
                        (actual_rentals - expected_rentals) &lt;= 0 
                        ~ 0), 
         down = case_when((expected_rentals - actual_rentals) &gt; 0 
                        ~ expected_rentals - actual_rentals, 
                        (expected_rentals - actual_rentals) &lt;= 0 
                        ~ 0))
# Create the graph
ggplot(df, aes(month, expected_rentals, group=1)) +
  geom_line(color=&quot;blue&quot;) +
  geom_line(aes(month, actual_rentals)) +
  facet_wrap(~year) +
  theme(axis.text.x = element_text(size = 5)) +
  ylim(15000, 45000) +
  
  #Filling of graph 
  geom_ribbon(aes(ymin=expected_rentals,ymax=expected_rentals+up), 
              fill=&quot;#7DCD85&quot;,
              alpha=0.4) +
  geom_ribbon(aes(ymin=expected_rentals,
                  ymax=expected_rentals-down), 
              fill=&quot;#CB454A&quot;,
              alpha=0.4) +
  
  theme_minimal() + 
  
  #Label the graph 
  labs(
    title = &quot;Monthly changes in TfL bik rentals&quot;,
    subtitle = &quot;Change from monthly average shown in blue
and calculated between 2016-2019&quot;,
    caption = &quot;Source: TfL, London Data Store&quot;,
    x = &quot;&quot;,
    y = &quot;Bike rentals&quot;) +
  NULL</code></pre>
<p><img src="/blogs/Bike%20Rentals%20Analysis_files/figure-html/montly%20change%20in%20bikes%20-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>The second one looks at percentage changes from the expected level of weekly rentals. The two grey shaded rectangles correspond to Q2 (weeks 14-26) and Q4 (weeks 40-52).</p>
<pre class="r"><code># Calculate weekly bike change average
weekly_expected_rentals &lt;- bike %&gt;% 
  filter(year %in% c(2016,2017,2018,2019)) %&gt;%  
  group_by(week) %&gt;% 
  summarize(expected_rentals=mean(bikes_hired))

# Calculate actual weekly bike change average
weekly_actual_rentals &lt;- bike %&gt;% 
  filter(year %in% c(2016,2017,2018,2019,2020,2021)) %&gt;%  
  group_by(year, week) %&gt;% 
  summarize(actual_rentals=mean(bikes_hired))

df1 &lt;- inner_join(weekly_expected_rentals, weekly_actual_rentals) %&gt;% 
  mutate(change = 100 * (actual_rentals - expected_rentals) / expected_rentals, 
         up = case_when(change &gt; 0 
                        ~ change, 
                        change &lt;= 0 
                        ~ 0), 
         down = case_when(change &gt; 0 
                        ~ 0, 
                        change &lt;= 0 
                        ~ change), 
         type = case_when(down == 0 ~ &quot;up&quot;,
                          up == 0 ~ &quot;down&quot;))

# Create the graph
ggplot(df1[1:292,], aes(week, change, group=1)) +
  
  #Create gray background
  geom_rect(aes(xmin=13,xmax=26),
            ymin=-Inf,ymax=Inf, fill=&quot;#E5E7E9&quot;, alpha=0.035) +
  geom_rect(aes(xmin=39,xmax=53),
            ymin=-Inf,ymax=Inf, fill=&quot;#E5E7E9&quot;, alpha=0.035) +
  geom_line() +
  
  #Create filling between graph 
  geom_ribbon(aes(ymin=0,ymax=up),fill=&quot;#7DCD85&quot;,alpha=0.4) +
  geom_ribbon(aes(ymin=0,ymax=down),fill=&quot;#CB454A&quot;,alpha=0.4) +
  
  #Create tickmarks at the side and set their color 
  geom_rug(aes(color=type), sides = &quot;b&quot;, 
           length = unit(0.04, &quot;npc&quot;), show.legend = FALSE) +
  scale_color_manual(values = c(&quot;#CB454A&quot;, &quot;#7DCD85&quot;))+
  
  #Facet, change theme and set scale 
  facet_wrap(~year) +
  theme_minimal() + 
  scale_y_continuous(labels = c(&quot;-50%&quot;,&quot;0%&quot;,&quot;50%&quot;,&quot;100%&quot;)) +
  scale_x_continuous(breaks = c(13,26,39,53), 
                   labels = c(&quot;13&quot;,&quot;26&quot;,&quot;39&quot;,&quot;53&quot;)) +
  
  #Label graph 
  labs(
    title = &quot;Weekly changes in TfL bike rentals&quot;,
    subtitle = &quot;%change from weekly averages 
calculated between 2016-2019&quot;,
    caption = &quot;Source: TfL, London Data Store&quot;,
    x = &quot;week&quot;,
    y = &quot;&quot;) +
  NULL</code></pre>
<p><img src="/blogs/Bike%20Rentals%20Analysis_files/figure-html/weekly%20change%20in%20bikes-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>For both of these graphs, we have to calculate the expected number of rentals per week or month between 2016-2019 and then, see how each week/month of 2020-2021 compares to the expected rentals. We use the calculation <code>excess_rentals = actual_rentals - expected_rentals</code>.</p>
<p>We used mean to calculate expected rentals since it incorporates the outliers well without shifting the expectation
too much in either direction. Outliers are rare (for example when the tube broke down) but they do have the probability to occur again and hence the mean is a better option in this case to calculate expected rentals.</p>
</div>
